{% extends 'app/base.html' %}

{% block title_block %}{{ listing.title }}{% endblock %}

{% block body_block %}
<div class="container mt-4">
    <!-- Bootstrap Carousel for Images -->
    {% if listing.images.all %}
    <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            {% for image in listing.images.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                <img src="{{ image.url }}" class="d-block w-100" alt="Listing Image">
            </div>
            {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
    {% endif %}

    <!-- Listing Details -->
    <div class="mt-4">
        <h1>{{ listing.title }}</h1>
        <p id="highestBid"><strong>Highest bid:</strong> £{{ listing.highest_bid.amount }}</p>
        <p><strong>Category:</strong> {{ listing.category }}</p>
        <p><strong>Description:</strong> {{ listing.description }}</p>
        <p><strong>Seller:</strong> {{ listing.seller.username }}</p>
        <p><strong>Posted on:</strong> {{ listing.created_at }}</p>
        <p><strong>Ends in:</strong> <span id="countdown"></span></p>
    </div>

    <!-- Bidding Section -->
    <div class="card mt-4">
        <div class="card-body">
            <h4 class="card-title">Place a Bid</h4>
            <form method="POST" id="bidForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="bidAmount" class="form-label">Your Bid (£)</label>
                    <input type="number" step="0.01" min="{{ listing.highest_bid.amount }}" class="form-control" id="amount" name="amount" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit Bid</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Error</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="message"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

<script>
    function updateCountdown() {
        const endTime = new Date("{{ listing.end_datetime|date:'Y-m-d H:i:s' }}").getTime();
        const countdownElement = $("#countdown")[0];
        
        function calculateTime() {
            const now = new Date().getTime();
            const timeLeft = endTime - now;
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                countdownElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else {
                countdownElement.innerHTML = "Listing Ended";
                clearInterval(timer);
            }
        }
        
        calculateTime();
        const timer = setInterval(calculateTime, 1000);
    }
    
    $(document).ready(function() {
        updateCountdown();

        $("#bidForm").submit(function(e) {
            e.preventDefault();

            $.ajax({
                type: "POST",
                url: "/bid/{{ listing.id }}",
                data: {
                    amount: $("#amount").val(),
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                },
                success: function() {
                    var amount = $("#amount").val();
                    $("#highestBid").html(`<strong>Highest bid:</strong> £${amount} - You are the highest bidder!`);
                },
                error: function(e) {
                    $("#message").text($.parseJSON(e.responseText).message);
                    const myModal = new bootstrap.Modal($("#errorModal"));
                    myModal.show();
                }
            });
        });
    });
</script>

{% endblock %}
